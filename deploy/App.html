<!DOCTYPE html>
<html>
<head>
    <title>Custom List</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (function(){var Ext=window.Ext4||window.Ext,getHiddenFieldConfig=function(name){return{name:name,xtype:"rallytextfield",hidden:!0,handlesEvents:{typeselected:function(type){this.setValue(null)}}}};Ext.define("Rally.apps.customlist.Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.CheckboxField"],getFields:function(app){return this.app=app,[{name:"type",xtype:"rallycombobox",allowBlank:!1,autoSelect:!1,shouldRespondToScopeChange:!0,context:this.app.getContext(),initialValue:"HierarchicalRequirement",storeConfig:{model:Ext.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable"],filters:[{property:"UserListable",value:!0}],autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{select:function(combo){this.app.clearFiltersAndSharedViews(),combo.fireEvent("typeselected",combo.getRecord().get("TypePath"),combo.context)},scope:this},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(context){this.refreshWithNewContext(context)}}},{type:"query"},{name:"showControls",xtype:"rallycheckboxfield",fieldLabel:"Show Control Bar"},getHiddenFieldConfig("columnNames"),getHiddenFieldConfig("order")]}})})();
                (function(){Ext.apply(Rally.ui.renderer.RendererFactory.fieldTemplates,{collaborators:function(){return Ext.create("CollaboratorsTemplate")}}),Ext.define("CollaboratorsTemplate",{extend:"Rally.ui.renderer.template.status.StatusTemplate",inheritableStatics:{onClick:function(event,ref){Rally.ui.renderer.template.status.StatusTemplate.onClick(event,ref,{field:"Collaborators"})}},constructor:function(){this.callParent(['<tpl if="this._getCollaboratorsCount(values) &gt; 0">','<a onclick="{[this._getOnClick(values)]}">','<span class="predecessorsandsuccessors-cnt">{[this._getCollaboratorsCount(values)]}</span>',"</a>","</tpl>"])},_getCollaboratorsCount:function(recordData){return recordData.Collaborators.Count},_getOnClick:function(recordData){return"CollaboratorsTemplate.onClick(event, '"+recordData._ref+"'); return false;"}})})();
                (function(){Ext.apply(Rally.ui.popover.PopoverFactory.popovers,{Collaborators:function(config){return Ext.create("CollaboratorsPopover",Ext.merge({context:{workspace:config.record.get("Workspace")._ref,project:null}},config))}}),Ext.define("CollaboratorsPopover",{extend:"Rally.ui.popover.ListViewPopover",id:"collaborators-popover",cls:"collaborators-popover",title:"Collaborators",constructor:function(config){config.listViewConfig=Ext.merge({addNewConfig:null,gridConfig:{storeConfig:{context:config.context,fetch:["FirstName","LastName","EmailAddress"]},columnCfgs:[{dataIndex:"FirstName",width:200},{dataIndex:"LastName",width:200},{dataIndex:"EmailAddress",flex:1}]},model:"user",childField:"Collaborators"},config.listViewConfig),this.callParent(arguments)}})})();
                (function(){var Ext=window.Ext4||window.Ext;Ext.define("Rally.apps.customlist.CustomListApp",{extend:"Rally.app.GridBoardApp",requires:["Deft.Promise","Rally.apps.customlist.Settings","Rally.data.BulkRecordUpdater","Rally.data.ModelTypes","Rally.data.PreferenceManager","Rally.data.util.Sorter","Rally.data.wsapi.Filter","Rally.ui.gridboard.plugin.GridBoardInlineFilterControl","Rally.ui.gridboard.plugin.GridBoardSharedViewControl","Rally.ui.notify.Notifier","Rally.util.String"],disallowedAddNewTypes:["user","userprofile","useriterationcapacity","testcaseresult","task","scmrepository","project","changeset","change","builddefinition","build","program"],orderedAllowedPageSizes:[10,25,50,100,200],readOnlyGridTypes:["build","change","changeset"],statePrefix:"customlist",allowExpansionStateToBeSaved:!1,isEditable:!0,config:{defaultSettings:{showControls:!0,type:"portfolioitem/feature"}},initComponent:function(){this.appName="CustomList-"+this.getAppId(),this.defaultSettings.url&&Ext.apply(this.defaultSettings,{type:this.defaultSettings.url}),this.callParent(arguments)},getSettingsFields:function(){return Rally.apps.customlist.Settings.getFields(this)},loadModelNames:function(){return this.modelNames=_.compact(this.getTypeSetting()),this._setColumnNames(this._getColumnNamesSetting()),Deft.Promise.when(this.modelNames)},addGridBoard:function(){this.callParent(arguments),this.getSetting("showControls")||this.gridboard.getHeader().hide()},loadGridBoard:function(){_.isEmpty(this.modelNames)?Ext.defer(function(){this.fireEvent("settingsneeded",this),this.publishComponentReady()},1,this):(this.enableAddNew=this._shouldEnableAddNew(),this.enableRanking=this._shouldEnableRanking(),this.callParent(arguments))},getGridConfig:function(){var config=_.merge(this.callParent(arguments),{allColumnsStateful:!0,enableEditing:0===_.intersection(this.readOnlyGridTypes,this.getTypeSetting()).length,listeners:{beforestaterestore:this._onBeforeGridStateRestore,beforestatesave:this._onBeforeGridStateSave,scope:this},pagingToolbarCfg:{hidden:!this.getSetting("showControls"),pageSizes:this.orderedAllowedPageSizes}}),invalidQueryFilters=Rally.util.Filter.findInvalidSubFilters(this._getQueryFilter(),this.models);return invalidQueryFilters.length&&(config.store.on("beforeload",function(store){return Ext.defer(function(){store.fireEvent("load",store,store.getRootNode(),[],!0)},1),!1}),this._showInvalidQueryMessage(config,_.map(invalidQueryFilters,function(filter){return'Could not find the attribute "'+filter.property.split(".")[0]+'" on type "'+this.models[0].displayName+'" in the query segment "'+(""+filter)+'"'},this))),config},getColumnCfgs:function(){return _.union(this.callParent(arguments),_.isEmpty(this.columnNames)&&this.enableRanking?["DragAndDropRank"]:[])},getFilterControlConfig:function(){return _.merge(this.callParent(arguments),{listeners:{beforestaterestore:{fn:this._onBeforeFilterButtonStateRestore,scope:this}}})},getGridBoardCustomFilterControlConfig:function(){var context=this.getContext(),isArtifactModel=this.models[0].isArtifact(),blackListFields=isArtifactModel?["ModelType","PortfolioItemType","LastResult"]:["ArtifactSearch","ModelType"],whiteListFields=isArtifactModel?["Milestones","Tags"]:[];this.models[0].isProject()?blackListFields.push("SchemaVersion"):this.models[0].isRelease()&&blackListFields.push("ChildrenPlannedVelocity","Version");var config={ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("custom-list-inline-filter"),legacyStateIds:[this.getScopedStateId("owner-filter"),this.getScopedStateId("custom-filter-button")],filterChildren:!0,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:isArtifactModel?["ArtifactSearch","Owner"]:[],addQuickFilterConfig:{blackListFields:blackListFields,whiteListFields:whiteListFields}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{blackListFields:blackListFields,whiteListFields:whiteListFields}}}}}};return isArtifactModel?config.inlineFilterButtonConfig.modelNames=this.modelNames:config.inlineFilterButtonConfig.model=this.models[0],config},getSharedViewConfig:function(){var context=this.getContext();return{ptype:"rallygridboardsharedviewcontrol",sharedViewConfig:{stateful:!0,stateId:context.getScopedStateId("custom-list-shared-view"),enableUrlSharing:this.isFullPageApp!==!1}}},getGridBoardConfig:function(){var config=this.callParent(arguments);return _.merge(config,{listeners:{viewchange:function(){this.loadGridBoard()},filterchange:function(){this.gridboard.getGridOrBoard().noDataPrimaryText=void 0,this.gridboard.getGridOrBoard().noDataSecondaryText=void 0},scope:this}})},onTreeGridReady:function(grid){grid.store.getTotalCount()>10&&this.gridboard.down("#pagingToolbar").show(),this.callParent(arguments)},getGridStoreConfig:function(){var sorters=this._getValidSorters(Rally.data.util.Sorter.sorters(this.getSetting("order")));if(_.isEmpty(sorters)){var rankField=this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled?"DragAndDropRank":"Rank",defaultSort=Rally.data.ModelTypes.areArtifacts(this.modelNames)?rankField:Rally.data.util.Sorter.getDefaultSort(this.modelNames[0]);sorters=Rally.data.util.Sorter.sorters(defaultSort)}return{listeners:{warning:{fn:this._onGridStoreWarning,scope:this}},pageSize:10,sorters:sorters}},getAddNewConfig:function(){var config={minWidth:700,openEditorAfterAddFailure:!1,margin:0};return _.merge(this.callParent(arguments),config)},getFieldPickerConfig:function(){return _.merge(this.callParent(arguments),{buttonConfig:{disabled:!this._userHasPermissionsToEditPanelSettings()},gridAlwaysSelectedValues:function(){return[]},gridFieldBlackList:this._shouldEnableRanking()?[]:["Rank"]})},getPermanentFilters:function(){return this._getQueryFilter().concat(this._getTimeboxScopeFilter()).concat(this._getProjectFilter())},onTimeboxScopeChange:function(){this.callParent(arguments),this.loadGridBoard()},clearFiltersAndSharedViews:function(){var context=this.getContext();this.gridboard&&(this.gridboard.down("rallyinlinefilterpanel").clear(),this.gridboard.down("rallysharedviewcombobox").reset()),Ext.create("Rally.data.wsapi.Store",{model:Ext.identityFn("preference"),autoLoad:!0,filters:[{property:"AppId",value:context.getAppId()},{property:"Type",value:"View"},{property:"Workspace",value:context.getWorkspace()._ref}],context:context.getDataContext(),listeners:{load:function(store,records){if(!_.isEmpty(records)){var batchStore=Ext.create("Rally.data.wsapi.batch.Store",{requester:this,data:records});batchStore.removeAll(),batchStore.sync()}store.destroyStore()},scope:this}})},getTypeSetting:function(){return(this.getSetting("type")||this.getSetting("url")||"").toLowerCase().split(",")},_getColumnNamesSetting:function(){return this.getSetting("columnNames")||(this.getSetting("fetch")||"").split(",")},_getQueryFilter:function(){var query=new Ext.Template(this.getSetting("query")).apply({projectName:this.getContext().getProject().Name,projectOid:this.getContext().getProject().ObjectID,user:this.getContext().getUser()._ref});if(query)try{return[Rally.data.wsapi.Filter.fromQueryString(query)]}catch(e){Rally.ui.notify.Notifier.showError({message:e.message})}return[]},_getProjectFilter:function(){return"milestone"===this.modelNames[0].toLowerCase()?[Rally.data.wsapi.Filter.or([{property:"Projects",operator:"contains",value:this.getContext().getProjectRef()},{property:"TargetProject",operator:"=",value:null}])]:[]},_getTimeboxScopeFilter:function(){var timeboxScope=this.getContext().getTimeboxScope(),hasTimeboxField=timeboxScope&&_.any(this.models,timeboxScope.isApplicable,timeboxScope);return hasTimeboxField?[timeboxScope.getQueryFilter()]:[]},_shouldEnableAddNew:function(){return 0===_.intersection(this.disallowedAddNewTypes,this.getTypeSetting()).length},_shouldEnableRanking:function(){return!_.contains(this.getTypeSetting(),"task")},_setColumnNames:function(columnNames){this.columnNames=_.compact(_.isString(columnNames)?columnNames.split(","):columnNames)},_onBeforeFilterButtonStateRestore:function(filterButton,state){if(state&&state.filters&&state.filters.length){var stateFilters=_.map(state.filters,function(filterStr){return Rally.data.wsapi.Filter.fromQueryString(filterStr)}),validFilters=Rally.util.Filter.removeNonapplicableTypeSpecificFilters(stateFilters,this.models);state.filters=_.invoke(validFilters,"toString")}},_hasViewSelected:function(){var sharedViewConfig=this.getSharedViewConfig().sharedViewConfig;if(sharedViewConfig&&sharedViewConfig.stateId){var value=(Ext.state.Manager.get(sharedViewConfig.stateId)||{}).value;return!_.isEmpty(value)}return!1},_onBeforeGridStateRestore:function(grid,state){if(state){if(state.columns){var appScopedColumnNames=this._getValidUuids(grid,this.getColumnCfgs()),userScopedColumnNames=this._getValidUuids(grid,state.columns);if(this._hasViewSelected())state.columns=userScopedColumnNames;else{var differingColumns=_.difference(appScopedColumnNames,userScopedColumnNames);differingColumns.length>0&&(state.columns=state.columns.concat(differingColumns)),state.columns=_.filter(state.columns,function(column){return _.contains(appScopedColumnNames,_.isObject(column)?column.dataIndex:column)},this)}}state.sorters&&(state.sorters=this._getValidSorters(state.sorters),_.isEmpty(state.sorters)&&delete state.sorters)}},_getValidUuids:function(grid,columns){return _.reduce(columns,function(result,column){var dataIndex=this._getColumnDataIndex(column),field=this._getModelField(grid,dataIndex);return field&&result.push(dataIndex),result},[],this)},_getModelField:function(grid,dataIndex){return grid.getModels()[0].getField(dataIndex)},_getColumnDataIndex:function(column){return _.isObject(column)?column.dataIndex:column},_onBeforeGridStateSave:function(grid,state){var newColumnNames=this._getColumnNamesFromState(state);_.isEmpty(newColumnNames)||(this._setColumnNames(newColumnNames),this._userHasPermissionsToEditPanelSettings()&&this.updateSettingsValues({settings:{columnNames:newColumnNames.join(",")}}))},_onGridStoreWarning:function(store,warnings,operation){var couldNotParseWarnings=_.filter(warnings,function(warning){return Rally.util.String.startsWith(warning,"Could not parse ")});couldNotParseWarnings.length&&(_.assign(operation.resultSet,{count:0,records:[],total:0,totalRecords:0}),this._showInvalidQueryMessage(this.gridboard.getGridOrBoard(),couldNotParseWarnings))},_showInvalidQueryMessage:function(gridOrGridConfig,secondaryTextStrings){gridOrGridConfig.noDataPrimaryText="Invalid Query",gridOrGridConfig.noDataSecondaryText=_.map(secondaryTextStrings,function(str){return"<div>"+str+"</div>"}).join("")},_getValidSorters:function(sorters){return _.filter(sorters,function(sorter){return _.any(this.models,function(model){var field=model.getField(sorter.property);return field&&field.sortable})},this)},_userHasPermissionsToEditPanelSettings:function(){return this.isEditable},_getColumnNamesFromState:function(state){return _(state&&state.columns).map(function(newColumn){return _.isObject(newColumn)?newColumn.dataIndex:newColumn}).compact().value()}})})();

            Rally.launchApp('Rally.apps.customlist.CustomListApp', {
                name:"Custom List",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .collaborators-popover-body .rui-left-right{display:none}
    </style>
</head>
<body>
</body>
</html>
